var freeGiftConfigMap = {
	7: 10001,
	8: 10000,
	54: -1,
	53: -2,
	51: -3,
	52: -4,
	55: -5,
	56: -6,

	57: 3,
	58: 5,
	59: 2,
	60: 4,
	61: 1,
	62: 6,
};

var freeGiftConfig = [{
	"asset_id": "45240",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_57_v_3.png",
	"id": 57,
	"msg": "卡片贝币X1已赠送，请在“卡箱”查看",
	"name": "卡片贝币",
	"rewards_name": "点经验",
	"show": 1,
	"type": "卡片"
}, {
	"asset_id": "45241",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_58_v_3.png",
	"id": 58,
	"msg": "卡片王莽币X1已赠送，请在“卡箱”查看",
	"name": "卡片王莽币",
	"rewards_name": "点经验",
	"show": 1,
	"type": "卡片"
}, {
	"asset_id": "45242",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_59_v_3.png",
	"id": 59,
	"msg": "卡片布币X1已赠送，请在“卡箱”查看",
	"name": "卡片布币",
	"rewards_name": "点经验",
	"show": 1,
	"type": "卡片"
}, {
	"asset_id": "45243",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_60_v_3.png",
	"id": 60,
	"msg": "卡片环钱X1已赠送，请在“卡箱”查看",
	"name": "卡片环钱",
	"rewards_name": "点经验",
	"show": 1,
	"type": "卡片"
}, {
	"asset_id": "45244",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_61_v_3.png",
	"id": 61,
	"msg": "卡片蚊鼻钱X1已赠送，请在“卡箱”查看",
	"name": "卡片蚊鼻钱",
	"rewards_name": "点经验",
	"show": 1,
	"type": "卡片"
}, {
	"asset_id": "45245",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_62_v_3.png",
	"id": 62,
	"msg": "卡片爱金X1已赠送，请在“卡箱”查看",
	"name": "卡片爱金",
	"rewards_name": "点经验",
	"show": 1,
	"type": "卡片"
}, {
	"asset_id": "43134",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_54_v_1.png",
	"id": 54,
	"msg": "卡片磬结X1已赠送，请在“卡箱”查看",
	"name": "卡片磬结",
	"rewards_name": "点经验",
	"show": 0,
	"type": "卡片"
}, {
	"asset_id": "43133",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_53_v_1.png",
	"id": 53,
	"msg": "卡片琵琶扣结X1已赠送，请在“卡箱”查看",
	"name": "卡片琵琶扣结",
	"rewards_name": "点经验",
	"show": 0,
	"type": "卡片"
}, {
	"asset_id": "43131",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_51_v_1.png",
	"id": 51,
	"msg": "卡片吉祥结X1已赠送，请在“卡箱”查看",
	"name": "卡片吉祥结",
	"rewards_name": "点经验",
	"show": 0,
	"type": "卡片"
}, {
	"asset_id": "43132",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_52_v_1.png",
	"id": 52,
	"msg": "卡片攀援结X1已赠送，请在“卡箱”查看",
	"name": "卡片攀援结",
	"rewards_name": "点经验",
	"show": 0,
	"type": "卡片"
}, {
	"asset_id": "43135",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_55_v_1.png",
	"id": 55,
	"msg": "卡片太阳结X1已赠送，请在“卡箱”查看",
	"name": "卡片太阳结",
	"rewards_name": "点经验",
	"show": 0,
	"type": "卡片"
}, {
	"asset_id": "43136",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_56_v_1.png",
	"id": 56,
	"msg": "卡片藻井结X1已赠送，请在“卡箱”查看",
	"name": "卡片藻井结",
	"rewards_name": "点经验",
	"show": 0,
	"type": "卡片"
}, {
	"asset_id": "29382",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_7_v_1.png",
	"id": 7,
	"msg": "已为您增加10点经验",
	"name": "10点魔卡经验",
	"rewards_name": "点经验",
	"show": 1,
	"type": "经验"
}, {
	"asset_id": "29383",
	"asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_8_v_1.png",
	"id": 8,
	"msg": "已为您增加20个魔法金币",
	"name": "20魔法金币 ",
	"rewards_name": "点经验",
	"show": 0,
	"type": "金币"
}];



(function() {
	window.V = window.V || {};
	V.event = V.event || {};
	var _defaultGetEventkeyFn = function(elem) {
		return elem.getAttribute("_event");
	};
	var _defalutJudgeFn = function(elem) {
		return !!elem.getAttribute("_event");
	};
	V.event.getWantTarget = function(evt, topElem, judgeFn) {
		judgeFn = judgeFn || this.judgeFn || _defalutJudgeFn;
		var _targetE = QZFL.event.getTarget(evt);
		while (_targetE) {
			if (judgeFn(_targetE)) {
				return _targetE;
			}
			if (topElem == _targetE) {
				break;
			}
			_targetE = _targetE.parentNode;
		}
		return null;
	};
	V.event.addHover = function(topElem, hoverClass, judgeFn) {
		var _opt;
		if (QZFL.lang.isString(hoverClass)) {
			_opt = {
				hoverClass: hoverClass
			};
		} else {
			_opt = hoverClass;
		}
		judgeFn = judgeFn || this.judgeFn || _defalutJudgeFn;
		QZFL.event.addEvent(topElem, "mouseover", function(e) {
			var _targetE = V.event.getWantTarget(e, topElem, judgeFn);
			if (_targetE) {
				QZFL.css.addClassName(_targetE, _opt.hoverClass);
				_opt.mouseover && _opt.mouseover.call(_targetE, e);
			}
		});
		QZFL.event.addEvent(topElem, "mouseout", function(e) {
			var _targetE = V.event.getWantTarget(e, topElem, judgeFn);
			if (_targetE) {
				QZFL.css.removeClassName(_targetE, _opt.hoverClass);
				_opt.mouseout && _opt.mouseout.call(_targetE, e);
			}
		});
	};
	V.event.bindCommonEvent = function(topElem, type, dealFnMap, getEventkeyFn) {
		getEventkeyFn = getEventkeyFn || _defaultGetEventkeyFn;
		var judgeFn = function(elem) {
			return !!getEventkeyFn(elem);
		};
		QZFL.event.on(topElem, type, function(e) {
			var _target = V.event.getWantTarget(e, topElem, judgeFn);
			if (_target) {
				var _event = getEventkeyFn(_target);
				if (dealFnMap[_event] && dealFnMap[_event].call(_target, e) === false) {
					QZFL.event.preventDefault(e);
				}
			}
		});
	};
})();
window.V = window.V || {};
V.module = V.module || {};
V.module.reporter = {
	_isReady: false,
	_isTcssJsReady: false,
	_queue: [],
	_hotClickQueue: [],
	_imgQueue: [],
	_reportImg: [],
	_speedConfig: null,
	_hasReportSpeed: false,
	_domain: "cw.qq.com",
	init: function(opt) {
		this._domain = opt.domain || this._domain;
		this._speedConfig = opt.speedConfig;
		if (opt.delay) {
			var _self = this;
			setTimeout(function() {
				_self._onReportReady();
			}, opt.delay);
		} else {
			this._onReportReady();
		}
	},
	_onReportReady: function() {
		this._isReady = true;
		for (var i = 0, _item; _item = this._imgQueue[i]; i++) {
			this._reportUseImg(_item);
		}
		this._imgQueue = [];
		var _t = new QZFL.JsLoader();
		_t.onload = function() {};
		_t.load("/ac/qzfl/stat.js?max_age=19851030", null, {
			"charset": "utf-8"
		});
		var _self = this;
		_t.onload = function() {
			_self._onTcssJsReady();
		};
		this.reportSpeed();
	},
	_onTcssJsReady: function() {
		this._isTcssJsReady = true;
		for (var i = 0, _item; _item = this._queue[i]; i++) {
			this.report(_item.url, _item.opt);
		}
		for (var i = 0, _item; _item = this._hotClickQueue[i]; i++) {
			this.reportHotClick(_item.tag, _item.url);
		}
		this._queue = [];
		this._hotClickQueue = [];
	},
	report: function(url, opt) {
		var sampling = 100;
		if (parseInt(Math.random() * sampling) != 0) {
			return;
		}
		try {
			opt = opt || {};
			if (this._isTcssJsReady) {
				TCISD.pv(this._domain, url, {
					referURL: opt.referURL,
					referDomain: opt.referDomain,
					referPath: opt.referPath,
					timeout: 0
				});
			} else {
				this._queue.push({
					url: url,
					opt: opt
				});
			}
		} catch (e) {}
	},
	reportHotClick: function(tag, url) {
		var sampling = 100;
		if (parseInt(Math.random() * sampling) != 0) {
			return;
		}
		try {
			if (this._isTcssJsReady) {
				TCISD.hotClick(tag, this._domain, url);
			} else {
				this._hotClickQueue.push({
					tag: tag,
					url: url
				});
			}
		} catch (e) {}
	},
	reportCgiRet: function(flag1, flag2, flag3, costTime, opt) {
		opt = opt || {};
		var flag1, flag2, flag3;
		if (flag1) {
			var url = "http://isdspeed.qq.com/cgi-bin/v.cgi";
			var _sampling = opt.sampling || 1;
			url += "?flag1=" + flag1 + "&flag2=" + flag2.toString() + "&1=" + _sampling + "&2=" + costTime;
			if (flag3 !== undefined)
				url += "&flag3=" + flag3.toString();
			this._reportUseImg(url);
		}
	},
	reportSpeed: function(index) {
		if (index) {
			window._timePoints[index] = new Date();
		}
		if (this._speedConfig && !this._hasReportSpeed) {
			var _config = this._speedConfig;
			var _report = true;
			for (var i = 0, _item; _item = _config.points[i]; i++) {
				if (!window._timePoints[_item]) {
					_report = false;
					break;
				}
			}
			if (_report) {
				var _startTime = window._timePoints[0],
					_arr = [];
				for (var i = 1, _item, l = window._timePoints.length; i < l; i++) {
					_item = window._timePoints[i]
					if (_item) {
						_arr.push((i) + "=" + (_item - _startTime));
					}
				}
				var _t = "flag1=" + _config.buzId + "&flag2=" + _config.siteId + "&flag3=" + _config.pageId;
				var _url = "http://isdspeed.qq.com/cgi-bin/r.cgi?" + _t + "&" + _arr.join("&");
				if (_config.sampling && _config.sampling > 1) {
					if (parseInt(Math.random() * _config.sampling) != 0) {
						_report = false;
					}
				}
				if (_report) {
					this._reportUseImg(_url);
					this._hasReportSpeed = true;
				}
			}
		}
	},
	_reportUseImg: function(url) {
		if (this._isReady) {
			var _imgSend = new Image();
			_imgSend.src = url;
			this._reportImg.push(_imgSend);
		} else {
			this._imgQueue.push(url)
		}
	}
};
window.SL = window.SL || {};
(function() {
	SL = {
		getLoginUin: function() {
			var uin = QZFL.cookie.get('uin') || QZFL.cookie.get('zzpaneluin');
			if (!uin) {}
			if (uin.length > 4) {
				return new Number(uin.replace(/o(\d+)/g, '$1')) + "";
			}
			return 0;
		},
		showLogin: function() {
			try {
				parent.SwfAppLib.method.showLoginBox();
			} catch (e) {}
		},
		showE: function(ele, block) {
			if (ele) {
				ele.style.display = block ? "block" : "";
			};
		},
		isHide: function(ele) {
			if (ele) {
				return ele.style.display == "none";
			}
		},
		hideE: function(elem) {
			if (elem) {
				elem.style.display = "none";
			};
		},
		tmpl: (function() {
			var cache = {};

			function _getTmplStr(rawStr, mixinTmpl) {
				if (mixinTmpl) {
					for (var p in mixinTmpl) {
						var r = new RegExp('<%#' + p + '%>', 'g');
						rawStr = rawStr.replace(r, mixinTmpl[p]);
					}
				}
				return rawStr;
			};
			return function tmpl(str, data, opt) {
				opt = opt || {};
				var key = opt.key,
					mixinTmpl = opt.mixinTmpl,
					strIsKey = !/\W/.test(str);
				key = key || (strIsKey ? str : null);
				var fn = key ? cache[key] = cache[key] || tmpl(_getTmplStr(strIsKey ? document.getElementById(str).innerHTML : str, mixinTmpl)) : new Function("obj", "var _p_=[],print=function(){_p_.push.apply(_p_,arguments);};with(obj){_p_.push('" + str.replace(/[\r\t\n]/g, " ").split("\\'").join("\\\\'").split("'").join("\\'").split("<%").join("\t").replace(/\t=(.*?)%>/g, "',$1,'").split("\t").join("');").split("%>").join("_p_.push('") + "');}return _p_.join('');");
				return data ? fn(data) : fn;
			};
		})(),
		log: function(msg) {
			if (window.console && window.console.log) {
				window.console.log(msg);
			}
		},
		getParam: function(name) {
			var r = new RegExp("(\\?|#|&)" + name + "=([^&#]*)(&|$|#)");
			var m = location.href.match(r);
			if (!m || m == "")
				m = top.location.href.match(r);
			return (!m ? "" : m[2]);
		},
		formatDate: function(date, formatStr) {
			var _str = formatStr || "yyyy-MM-dd HH:mm:ss";
			var _retStr = _str.replace("yyyy", date.getFullYear()).replace("MM", date.getMonth() + 1 < 10 ? ("0") + (date.getMonth() + 1) : date.getMonth() + 1).replace("dd", date.getDate() < 10 ? ("0" + date.getDate()) : date.getDate()).replace("HH", date.getHours() < 10 ? ("0" + date.getHours()) : date.getHours()).replace("hh", date.getHours() % 12 < 10 ? ("0" + date.getHours() % 12) : date.getHours() % 12).replace("mm", date.getMinutes() < 10 ? ("0" + date.getMinutes()) : date.getMinutes()).replace("ss", date.getSeconds() < 10 ? ("0" + date.getSeconds()) : date.getMinutes()).replace("wd", ["日", "一", "二", "三", "四", "五", "六"][date.getDay()]);
			return _retStr;
		}
	};
})();
window.freeGift = window.freeGift || {};
freeGift.config = freeGift.config || {};
var _cgiDomain = /pengyou\.com$/.test(location.host) ? "hydra.pengyou.com" : "hydra.qzone.qq.com";
var _oldGiftDomain = /pengyou\.com$/.test(location.host) ? "nc.xiaoyou.pengyou.com" : "nc.qzone.qq.com";
freeGift.config = {
	reportDomain: "component.snsapp.qq.com",
	speedReport: {
		buzId: 7721,
		siteId: 122,
		pageId: 1,
		points: [3],
		sampling: 10
	}
};
freeGift.config.daoConfig = {
	"sendInfo": {
		url: "http://" + _cgiDomain + "/cgi-bin/freegift/freegift_get_frds",
		type: "get",
		maxAge: 100,
		reportFlag: 161037,
		sampling: 10
	},
	"sendGfit": {
		url: "http://" + _cgiDomain + "/cgi-bin/freegift/freegift_send",
		type: "POST",
		maxAge: 100,
		reportFlag: 161038,
		sampling: 10
	},
	"receiveInfo": {
		url: "http://" + _cgiDomain + "/cgi-bin/freegift/freegift_get_list",
		type: "get",
		maxAge: 100,
		reportFlag: 161039,
		sampling: 10
	},
	"receiveGift": {
		url: "http://" + _cgiDomain + "/cgi-bin/freegift/freegift_take",
		type: "POST",
		maxAge: 100,
		reportFlag: 161040,
		sampling: 10
	},
	"oldGiftReceiveInfo": {
		url: "http://" + _oldGiftDomain + "/cgi-bin/cgi_farm_request_count_unrecv",
		type: "POST",
		maxAge: 100,
		reportFlag: 161041,
		sampling: 10
	},
	"oldGiftReceiveGift": {
		url: "http://" + _oldGiftDomain + "/cgi-bin/cgi_farm_request_gift_recv_all",
		type: "POST",
		maxAge: 100,
		reportFlag: 161042,
		sampling: 10
	}
};
window.V = window.V || {};
V.module = V.module || {};
V.module.AbstractDAO = function() {
	this.init.apply(this, arguments);
};
V.module.AbstractDAO.prototype = {
	init: function(opt) {
		this._config = opt.config || {};
	},
	getData: function(opt) {
		var _cgiConfig = null,
			data = opt.data || {}, cb = opt.cb;
		if (opt.key) {
			_cgiConfig = this._config[opt.key];
		} else {
			_cgiConfig = {
				url: opt.url,
				type: opt.type,
				maxAge: opt.maxAge === undefined ? opt.maxAge : 0,
				reportFlag: opt.reportFlag
			};
		}
		if (_cgiConfig) {
			if (this.validate() === false) {
				return;
			}
			var _self = this,
				_url = this._addToken(_cgiConfig.url),
				_startTime = new Date();
			var _cb = function(re) {
				var _endTime = new Date();
				_self.report(re, _endTime - _startTime, _cgiConfig);
				if (_self.dealRet(re)) {
					cb && cb(re);
				}
			};
			this.addParam(data);
			if (_cgiConfig.type && (_cgiConfig.type.toLowerCase() == "post")) {
				this.postForm(_url, data, _cb);
			} else {
				this.getJson(_url, data, _cb);
			}
		}
	},
	_addToken: function(url) {
		return url + (url.indexOf("?") < 0 ? "?" : "&") + "g_tk=" + this._getToken();
	},
	addParam: function(data) {},
	validate: function() {
		return true;
	},
	_getToken: function() {
		var hash = 5381,
			str = QZFL.cookie.get('skey');
		for (var i = 0, len = str.length; i < len; ++i) {
			hash += (hash << 5) + str.charCodeAt(i);
		}
		return hash & 0x7fffffff;
	},
	getJson: function(url, data, callback) {},
	postForm: function(url, data, callback) {},
	report: function(re, costTime, config) {},
	dealRet: function() {}
};
(function() {
	window.CrossDAO = function() {
		this.init.apply(this, arguments);
	};
	QZFL.object.extend(window.CrossDAO.prototype, V.module.AbstractDAO.prototype);
	QZFL.object.extend(window.CrossDAO.prototype, {
		addParam: function(data) {
			data["uin"] = SL.getLoginUin();
			data["cb"] = 1;
			data["r"] = Math.random();
		},
		validate: function() {
			if (!SL.getLoginUin()) {
				SL.showLogin();
				return false;
			}
			return true;
		},
		getJson: function(url, data, callback) {
			data = data || {};
			var _loader = new QZFL.JSONGetter(url, null, data, "utf-8");
			_loader.onSuccess = function(re) {
				try {
					if (re.ecode !== undefined) {
						re.code = re.ecode;
					}
					callback(re);
				} catch (e) {
					callback({
						code: -98,
						error: true
					});
				}
			};
			_loader.onError = function(re) {
				callback({
					code: -99,
					error: true
				});
			};
			_loader.send("_Callback");
			return _loader;
		},
		postForm: function(url, data, callback) {
			data = data || {};
			var _fs = new QZFL.FormSender(url, "post", data, "utf-8");
			_fs.onSuccess = function(re) {
				try {
					if (re.ecode !== undefined) {
						re.code = re.ecode;
					}
					callback(re);
				} catch (e) {
					callback({
						code: -98,
						error: true
					});
				}
			};
			_fs.onError = function(re) {
				callback({
					code: -99,
					error: true
				});
			};
			_fs.send();
		},
		report: function(re, costTime, cgiConfig) {
			var _flag1, _flag2, _flag3;
			if (cgiConfig.reportFlag) {
				_flag1 = cgiConfig.reportFlag;
				_flag2 = re.code >= 0 ? 1 : 2;
				_flag3 = re.code;
				var _opt = {
					sampling: cgiConfig.sampling
				};
				var _report = true;
				if (_opt.sampling && _opt.sampling > 1) {
					if (parseInt(Math.random() * _opt.sampling) != 0) {
						_report = false;
					}
				}
				var _ua = QZFL.userAgent;
				var _browser = "other";
				if (_ua.ie) {
					_browser = "ie" + _ua.ie;
				} else if (_ua.chrome) {
					_browser = "chrome";
				} else if (_ua.safari) {
					_browser = "safari";
				} else if (_ua.firefox) {
					_browser = "firefox";
				}
				if (costTime > 5000) {
					V.module.reporter.reportHotClick("free_gift." + _flag1 + "delay5." + _browser, "/free_gift/" + freeGift.appId);
				}
				if (costTime > 10000) {
					V.module.reporter.reportHotClick("free_gift." + _flag1 + "delay10." + _browser, "/free_gift/" + freeGift.appId);
				}
				if (costTime > 20000) {
					V.module.reporter.reportHotClick("free_gift." + _flag1 + "delay20." + _browser, "/free_gift/" + freeGift.appId);
				}
				if (costTime > 5000) {
					costTime = 1000;
					_flag3 = -88;
				}
				if (_report) {
					V.module.reporter.reportCgiRet(_flag1, _flag2, _flag3, costTime, _opt);
				}
			}
		},
		dealRet: function(re) {
			if ((re.code == -99 || re.code == -98) && re.error) {
				return false;
			}
			return true;
		}
	});
})();
window.freeGift = window.freeGift || {};
window.freeGift.appId = window.platForm;
window.freeGift.gifts = {};
freeGift.init = function() {
	for (var i = 0, _item; _item = freeGiftConfig[i]; i++) {
		freeGift.gifts[_item.id] = _item;
	}
	freeGift.dao = new CrossDAO({
		config: freeGift.config.daoConfig
	});
	var _callback = function(re) {
		if (re.ecode == 0) {
			V.module.reporter.reportSpeed(3);
			freeGift.friends.init(re);
			freeGift.sendPage.init(re);
			freeGift.receivePage.onFriendListReady();
		} else {
			if (re.msg) {
				freeGift.dialog.show(re.msg);
			} else {
				freeGift.dialog.show("系统繁忙，请稍后再试");
			}
		}
	};
	freeGift.receivePage.init();
	freeGift.dao.getData({
		key: "sendInfo",
		data: {
			appid: freeGift.appId
		},
		cb: _callback
	});
	freeGift.dialog.init();
	if (353 == freeGift.appId) {
		freeGift.oldGiftPage.init();
	}
	if (SL.getParam("page") == "receive") {
		freeGift.toPage("receive");
	} else {
		freeGift.toPage("send");
	}
	V.event.bindCommonEvent($("flashGiftDetail"), "click", {
		toFlashDetail: function() {
			try {
				parent.C.canvas.dialogCallback({
					call: "handbook",
					gift: window.giftSerialId[window.platForm]
				});
				parent.C.canvas.closeDialog();
			} catch (e) {}
		}
	});
};
freeGift.toPage = function(_page, param) {
	var _sendPageElem = $("sendPage");
	var _receivePageElem = $("receivePage");
	var _oldGiftPageElem = $("oldGiftPage");
	var _menuCtrolElem = $("menuCtrol");
	$e(_menuCtrolElem).find("a").removeClass("current");
	$e(_menuCtrolElem).find("a[rel=" + _page + "]").addClass("current");
	if (_page == "send") {
		_sendPageElem.style.display = "";
		_receivePageElem.style.display = "none";
		_oldGiftPageElem.style.display = "none";
		if (param) {
			freeGift.sendPage.initFriendSelect(param);
		}
	} else if (_page == "oldGift") {
		_receivePageElem.style.display = "none";
		_sendPageElem.style.display = "none";
		_oldGiftPageElem.style.display = "block";
	} else {
		_receivePageElem.style.display = "block";
		_sendPageElem.style.display = "none";
		_oldGiftPageElem.style.display = "none";
		freeGift.receivePage.update();
	}
};
freeGift.friends = {
	_recommendFriends: [],
	_quota: 0,
	_sendFriends: [],
	_maxRecommend: 5,
	_sendUins: [],
	_expSortUins: [],
	_leftFriends: [],
	_uinMap: {},
	init: function(data) {
		this._recommendFriends = data.def_friends;
		this._quota = data.quota_num;
		for (var i = 0, _item; _item = data.friends[i]; i++) {
			this._leftFriends.push(_item.uin);
			this._uinMap[_item.uin] = true;
		}
		try {
			var _arr = parent.C.canvas.getExpFriends();
			Array.prototype.push.apply(this._expSortUins, _arr);
		} catch (e) {}
	},
	getRecommend: function() {
		var _max = Math.min(this._maxRecommend, this._quota);
		var _result = [];
		var _hasSelect = {};
		for (var i = 0, _item; _item = this._recommendFriends[i]; i++) {
			if (_result.length < _max) {
				_result.push(_item);
				_hasSelect[_item] = true;
			}
		}
		for (var i = 0, _item; _item = this._expSortUins[i]; i++) {
			if (_result.length < _max && !_hasSelect[_item] && this._uinMap[_item]) {
				_result.push(_item);
				_hasSelect[_item] = true;
			}
		}
		while (_result.length < _max) {
			if (this._leftFriends.length > _result.length) {
				var _index = parseInt(Math.random() * this._leftFriends.length);
				var _uin = this._leftFriends[_index];
				if (!_hasSelect[_uin]) {
					_result.push(_uin);
					_hasSelect[_uin] = true;
				}
			} else {
				break;
			}
		}
		return _result;
	},
	getQuota: function() {
		return this._quota;
	},
	sendGift: function(uins) {
		var _o = this._convertArrToMap(uins);
		for (var i = 0, _item; _item = this._leftFriends[i]; i++) {
			if (_o[_item]) {
				this._leftFriends.splice(i, 1);
				i--;
			}
		}
		for (var i = 0, _item; _item = this._expSortUins[i]; i++) {
			if (_o[_item]) {
				this._expSortUins.splice(i, 1);
				i--;
			}
		}
		for (var i = 0, _item; _item = this._recommendFriends[i]; i++) {
			if (_o[_item]) {
				this._recommendFriends.splice(i, 1);
				i--;
			}
		}
		this._quota = this._quota - uins.length;
	},
	_convertArrToMap: function(items) {
		var _o = {};
		for (var i = 0, _item; _item = items[i]; i++) {
			_o[_item] = true;
		}
		return _o;
	}
};
freeGift.oldGiftPage = {
	_inSend: false,
	init: function() {
		var _self = this;
		var _date = new Date(2012, 11, 1, 0, 0);
		var _now = new Date();
		if (_date.getTime() < _now.getTime()) {
			return;
		}
		this._getData(function() {
			$("oldGiftMenu").style.display = "";
			_self._bindEvent();
		});
	},
	_bindEvent: function() {
		var _self = this;
		QZFL.event.on($("getOldGiftBtn"), "click", function() {
			_self._receive(_self._receiveComplete);
		});
	},
	_getData: function(cb) {
		var _param = {
			appid: freeGift.appId
		};
		var _cb = function(re) {
			if (re && re.unRecvNum) {
				cb && cb(re);
			}
		};
		freeGift.dao.getData({
			key: "oldGiftReceiveInfo",
			data: _param,
			cb: _cb
		});
	},
	_receive: function(cb) {
		var _param = {
			appid: freeGift.appId
		};
		var _self = this;
		this._inSend = true;
		var _cb = function(re) {
			_self._inSend = false;
			if (re.ecode == 0) {
				try {
					parent.C.canvas.dialogCallback(re.change);
				} catch (e) {}
				if (re.rewards) {
					freeGift.dialog.show("领取成功！领取" + re.rewards);
				} else {
					freeGift.dialog.show("领取成功！");
				}
				cb && cb(re);
			} else {
				if (re.direction) {
					freeGift.dialog.show(re.direction);
				} else {
					freeGift.dialog.show("系统繁忙，请稍后再试");
				}
			}
		};
		freeGift.dao.getData({
			key: "oldGiftReceiveGift",
			data: _param,
			cb: _cb
		});
	},
	_receiveComplete: function(re) {
		$("oldGiftMenu").style.display = "none";
		freeGift.toPage("send");
	}
};
freeGift.dialog = {
	_tipElem: null,
	_tipTimer: null,
	_rewardTipElem: null,
	_rewardTipTimer: null,
	_sendMsgTip: null,
	init: function() {
		this._tipElem = $("msgTip");
		this._sendMsgTip = $("sendMsgTip");
		this._rewardTipElem = $("rewardTip");
		this._bindEvent();
	},
	_bindEvent: function() {
		var _self = this;
		V.event.bindCommonEvent(this._sendMsgTip, "click", {
			cancel: function() {
				_self._sendMsgTip.style.display = "none";
			},
			newFriends: function() {
				freeGift.sendPage.initFriendSelect();
				_self._sendMsgTip.style.display = "none";
			}
		});
	},
	show: function(msg) {
		clearTimeout(this._tipTimer);
		this._tipElem.style.display = "";
		$e(this._tipElem).find("div").setHtml(msg);
		this._setPosition($e(this._tipElem).find("div").elements[0]);
		var _self = this;
		this._tipTimer = setTimeout(function() {
			_self._tipElem.style.display = "none";
		}, 2000);
	},
	showReward: function(msg, gift) {
		clearTimeout(this._rewardTipTimer);
		this._rewardTipElem.style.display = "";
		this._rewardTipElem.innerHTML = SL.tmpl("rewardTipTemp", {
			gift: gift,
			msg: msg
		});
		this._setPosition(this._rewardTipElem);
		var _self = this;
		this._rewardTipTimer = setTimeout(function() {
			_self._rewardTipElem.style.display = "none";
		}, 2000);
	},
	_setPosition: function(elem) {
		var _size = QZFL.dom.getSize(elem);
		var _width = _size[0],
			_height = _size[1];
		var _clientWidth = QZFL.dom.getClientWidth(document);
		var _clientHeight = QZFL.dom.getClientHeight(document);
		var _l = (_clientWidth - _width) / 2 - 75;
		var _t = (_clientHeight - _height) / 2;
		elem.style.left = (_l > 0 ? _l : 0) + "px";
		elem.style.top = (_t > 0 ? _t : 0) + "px";
	},
	showSendMsgTip: function(msg) {
		this._sendMsgTip.style.display = "";
		$e(this._sendMsgTip).find("span[rel=msg]").setHtml(msg);
		this._setPosition($e(this._sendMsgTip).find("div.g_pop_tips").elements[0]);
	}
};
freeGift.sendPage = {
	_sendGiftListElem: null,
	_leftCount: 0,
	_friendSelector: null,
	_giftSelectClass: "item_selected",
	_maxSelectOnce: 10,
	_sendReport: 0,
	_inSend: false,
	_sendFeedsCount: 0,
	init: function(data) {
		var _self = this;
		this._sendGiftListElem = $("sendGiftList");
		var _selectFriendElem = $("friendSelector");
		this._render();
		if (353 == window.platForm) {
			var _tipsElement = $("flashGiftDetail");
			_tipsElement && (_tipsElement.innerHTML = '<span class="collection_stationery collection_stationery_tree" style="background:none"></span>本期种子均来自图鉴<a href="javascript:void(0);" _event="toFlashDetail" onclick="return false;" title=""> ' + window.giftSerialName[353] + '</a> 系列<a href="javascript:void(0);" _event="toFlashDetail" onclick="return false;" class="detail" title="">查看详情>></a>');
			_tipsElement && (_tipsElement.style.display = "block");
		} else if (358 == window.platForm) {
			var _tipsElement = $("flashGiftDetail");
			_tipsElement && (_tipsElement.innerHTML = '<span class="collection_stationery collection_stationery_sheep" style="background:none"></span>本期幼仔均来自图鉴<a href="javascript:void(0);" _event="toFlashDetail" onclick="return false;" title=""> ' + window.giftSerialName[358] + '</a> 系列<a href="javascript:void(0);" _event="toFlashDetail" onclick="return false;" class="detail" title="">查看详情>></a>');
			_tipsElement && (_tipsElement.style.display = "block");
		} else if (365 == window.platForm) {
			var _tipsElement = $("flashGiftDetail");
			_tipsElement && (_tipsElement.innerHTML = '<a href="http://sobar.soso.com/t/92360964" title="详细说明" target="_blank">赠送/索要礼物说明</a>');
			_tipsElement && (_tipsElement.style.display = "block");
		}
		this._bindEvent();
		this._friendSelector = new QZFL.widget.FriendSelector(_selectFriendElem, {
			uin: SL.getLoginUin(),
			maxShowSelect: this._maxSelectOnce,
			maxSelect: this._maxSelectOnce,
			data: data
		});
		this._friendSelector.showMsg = function(msg) {
			var _selectedFriends = _self._friendSelector.getSelectFriends();
			var _count = _selectedFriends.length;
			if (freeGift.friends.getQuota() > _count) {
				freeGift.dialog.show("每次最多送礼给10个好友");
			} else {
				freeGift.dialog.show("每天最多赠送给50个好友礼物哦！今天还可以赠送" + freeGift.friends.getQuota() + "个好友");
			}
		};
		this._friendSelector.onSelectFriend = function() {
			_self._sendReport = 1;
			var _selectedFriends = _self._friendSelector.getSelectFriends();
			var _count = _selectedFriends.length;
			var _elem = _self._friendSelector.getMainDom();
			if (_count >= 6) {
				QZFL.css.addClassName(_elem, "two_lines_selector");
				$("tips1").style.display = "none";
			} else {
				QZFL.css.removeClassName(_elem, "two_lines_selector");
				$("tips1").style.display = "";
			}
			var _countLeft = 0;
			if (_count > 5) {
				_countLeft = 10 - _count;
			} else {
				_countLeft = 5 - _count;
			}
			if (_countLeft > 0) {
				_self._friendSelector.setSearchInputWidth(_countLeft > 1 ? 140 : 85);
			} else {
				_self._friendSelector.setSearchInputWidth(20);
			}
		};
		this.initFriendSelect();
	},
	initFriendSelect: function(uins) {
		var _quota = freeGift.friends.getQuota();
		var _show = true,
			_msg;;
		if (_quota) {
			this._friendSelector.empty();
			var _uins = uins || freeGift.friends.getRecommend();
			if (_uins.length > 0) {
				this._friendSelector.addFriends(_uins);
				this._friendSelector.setMaxSelect(Math.min(_quota, this._maxSelectOnce));
				this._sendReport = 0;
			} else {
				_show = false;
				_msg = "没有好友可以赠送啦！添加更多好友互相赠送礼物吧！";
			}
		} else {
			_show = false;
			_msg = "每天最多赠送给50个好友礼物哦！今天已达到送礼上限！";
		}
		if (!_show) {
			$("friendSelector").style.display = "none";
			$("friendSelectorHide").style.display = "";
			$("tips1") && ($("tips1").style.visibility = "hidden");
			$e("#friendSelectorHide").find("input").elements[0].value = _msg;
		}
	},
	_render: function() {
		var _html = [];
		//
		_freeGiftConfig = freeGiftConfig.sort(function(a, b) {
			return freeGiftConfigMap[b.id] - freeGiftConfigMap[a.id];
		});
		//for (var i = 0, _item; _item = freeGiftConfig[i]; i++) {
		for (var i = 0, _item; _item = _freeGiftConfig[i]; i++) {
			if (_item.show) {
				_html.push(SL.tmpl("sendGiftItemTemp", {
					item: _item
				}));
			}
		}
		this._sendGiftListElem.innerHTML = _html.join("");
	},
	_bindEvent: function() {
		var _self = this;
		V.event.bindCommonEvent(this._sendGiftListElem, "click", {
			selectGift: function() {
				var _selectClass = _self._giftSelectClass;
				$e(_self._sendGiftListElem).find("li." + _selectClass).removeClass(_selectClass);
				QZFL.css.addClassName(this, _selectClass);
			}
		});
		var _sendBtnElem = $("sendBtn");
		QZFL.event.on(_sendBtnElem, "click", function() {
			_self._sendGift();
		});
	},
	_sendGift: function() {
		if (this._inSend) {
			return;
		}
		V.module.reporter.reportHotClick("freegift." + window.freeGift.appId + ".send_page.send_all", "/free_gfit/" + freeGift.appId);
		V.module.reporter.reportHotClick("freegift." + window.freeGift.appId + ".send_page.send" + this._sendReport + "", "/free_gfit/" + freeGift.appId);
		var _selectedGiftElem = $e(this._sendGiftListElem).find("li." + this._giftSelectClass).elements[0];
		if (!_selectedGiftElem) {
			freeGift.dialog.show("请选择礼物");
			return;
		}
		var _selectedFriends = this._friendSelector.getSelectFriends();
		if (!_selectedFriends || _selectedFriends.length == 0) {
			freeGift.dialog.show("请选择好友");
			return;
		}
		var _uins = [];
		var _uinLost = [];
		var _lostCount = 0;
		for (var i = 0, _item; _item = _selectedFriends[i]; i++) {
			_uins.push(_item.uin);
			var tempLost = (_item.lost == 1);
			_uinLost.push(tempLost);
			if (tempLost) {
				_lostCount++;
			}
		}
		this._sendFeedsCount += _lostCount;
		var _freegiftId = _selectedGiftElem.getAttribute("gid")
		var _param = {
			appid: freeGift.appId,
			friends: _uins.join(";"),
			freegift_id: _freegiftId,
			sfcount: _lostCount
		};
		var _self = this;
		_self._inSend = true;
		var _cb = function(re) {
			_self._inSend = false;
			if (re.ecode == 0) {
				freeGift.dialog.showSendMsgTip("赠送成功,已为您增加" + re.rewards + freeGift.gifts[_freegiftId].rewards_name);
				freeGift.friends.sendGift(_uins);
				_self._friendSelector.removeFriends(_uins);
				_self._friendSelector.empty();
				try {
					parent.C.canvas.dialogCallback(re.change);
				} catch (e) {}
				if (_sendFeedsCount < 4) {
					var fgUins = [];
					for (var i = 0, len = _uins.length; i < len; i++) {
						if (fgUins.length < 3 && _uinLost[i]) {
							fgUins.push(_uins[i])
						}
					}
					if (fgUins.length > 0) {
						var srParmas = {
							"type": "freegift",
							"receiver": fgUins,
							"title": _self._appMap[freeGift.appId] + "礼物",
							"msg": "送你一份" + _self._appMap[freeGift.appId] + "礼物，期待你的回赠哦！",
							"img": freeGift.gifts[_freegiftId].asset_url_freegift,
							"desc": _self._appMap[freeGift.appId] + freeGift.gifts[_freegiftId].name,
							"access": 3
						};
						parent.fusion2.dialog.sendRequest(srParmas);
					}
				}
			} else {
				if (re.msg) {
					freeGift.dialog.show(re.msg);
				} else {
					freeGift.dialog.show("系统繁忙，请稍后再试");
				}
			}
		};
		freeGift.dao.getData({
			key: "sendGfit",
			data: _param,
			cb: _cb
		});
	},
	getFriendSelector: function() {
		return this._friendSelector;
	}
};
freeGift.receivePage = {
	_friendSelectClass: "item_selected",
	_receiveGiftListElem: null,
	_friendListReady: false,
	_receiveInfoReady: false,
	_hasRender: false,
	_receiveInfo: null,
	_needUpdate: false,
	_hasReceive: false,
	init: function() {
		var _self = this;
		this._receiveGiftListElem = $("receiveGiftList");
		this.getData(function(re) {
			_self._receiveInfo = re;
			_self._receiveInfoReady = true;
			_self._checkCanRender(re);
			//start
			$('menuCtrol').getElementsByTagName("a")[1].style.cssText = "background:none;text-indent:0;";
			$('menuCtrol').getElementsByTagName("a")[1].innerHTML = "收到礼物(" + re.freegifts.length + ")";
			//end
		});
		_self._bindEvent();
	},
	_checkCanRender: function() {
		if (this._receiveInfoReady && !this._hasRender) {
			var re = this._receiveInfo;
			var _flag = false;
			if (this._friendListReady) {
				_flag = true;
			} else if (re.freegifts && re.freegifts.length) {
				_flag = true;
			}
			if (_flag) {
				this._hasRender = true;
				this._render(re);
			}
		}
	},
	_render: function(re) {
		if (re.freegifts && re.freegifts.length) {
			var _html = [];
			// start
			var tempArr = re.freegifts.sort(function(a, b) {
				if (a.freegift_id == 7 || a.freegift_id == 8)
					return -1;
				if (b.freegift_id == 7 || b.freegift_id == 8)
					return 1;
				if (a.flags != b.flags) return a.flags - b.flags;
				else
					return freeGiftConfigMap[b.freegift_id] - freeGiftConfigMap[a.freegift_id];
			});
			//for (var i = 0, _item; _item = re.freegifts[i]; i++) {
			for (var i = 0, _item; _item = tempArr[i]; i++) {
				// end
				if (freeGift.gifts[_item.freegift_id]) {
					_html.push(SL.tmpl("receiveGiftItemTemp", {
						item: _item,
						gift: freeGift.gifts[_item.freegift_id]
					}));
				}
			}
			this._receiveGiftListElem.innerHTML = _html.join("");
		} else {
			this._needUpdate = true;
			this.update();
		}
	},
	update: function() {
		if (this._needUpdate) {
			var _page = $("receivePage");
			QZFL.css.addClassName(_page, "no_present");
			var _friends = [];
			var _recommendUins = freeGift.friends.getRecommend();
			if (_recommendUins.length > 0) {
				for (var i = 0, _item; _item = _recommendUins[i]; i++) {
					_friends.push(freeGift.sendPage.getFriendSelector().getFriend(_item));
				}
			} else {
				$e(_page).find("div.no_present_box").addClass("no_friend");
			}
			$("noGiftShow").innerHTML = SL.tmpl("noGiftShowTemp", {
				hasReceive: this._hasReceive,
				friends: _friends,
				quota: freeGift.friends.getQuota(),
				hasSendBefore: true,
				selectClass: this._friendSelectClass
			});
		}
	},
	_bindEvent: function() {
		var _self = this;
		var _onReveiceBtnClick = function(ele, type, msg, reportType) {
			if (ele.getAttribute("inSend") == "true") {
				return;
			}
			var _giftId = ele.getAttribute("rid");
			var _giftIndex = ele.getAttribute("gid");
			_self._receiveGift(_giftId, type, function(re) {
				if (re.ecode == 0) {
					_self._receiveGiftComplete(_giftIndex, _giftId, msg);
				} else {
					$e(ele.parentNode).find("[_event]").each(function(el) {
						el.removeAttribute("inSend");
					});
				}
			});
			V.module.reporter.reportHotClick("freegift." + window.freeGift.appId + ".receive_page.receive_all", "/free_gfit/" + freeGift.appId);
			V.module.reporter.reportHotClick("freegift." + window.freeGift.appId + ".receive_page.receive_" + reportType + "", "/free_gfit/" + freeGift.appId);
			$e(ele.parentNode).find("[_event]").each(function(el) {
				el.setAttribute("inSend", "true");
			});
		};
		V.event.bindCommonEvent(this._receiveGiftListElem, "click", {
			receive: function() {
				_onReveiceBtnClick(this, 1, "接受并回赠成功！", 1);
			},
			receiveOnly: function() {
				_onReveiceBtnClick(this, 2, "接受成功！", 2);
			},
			onlyReceive: function() {
				_onReveiceBtnClick(this, 2, "接受成功！", 3);
			}
		});
		var _noGiftShowElem = $("noGiftShow");
		V.event.bindCommonEvent(_noGiftShowElem, "click", {
			selectFriend: function() {
				if (QZFL.css.hasClassName(this, _self._friendSelectClass)) {
					QZFL.css.removeClassName(this, _self._friendSelectClass);
				} else {
					QZFL.css.addClassName(this, _self._friendSelectClass);
				}
			},
			toSendPage: function() {
				var _selectedElem = $e(_noGiftShowElem).find("li." + _self._friendSelectClass).elements;
				var _uins = [];
				for (var i = 0, _item; _item = _selectedElem[i]; i++) {
					_uins.push(_item.getAttribute("fuin"));
				}
				freeGift.toPage("send", _uins.length > 0 ? _uins : null);
				V.module.reporter.reportHotClick("freegift." + window.freeGift.appId + ".receive_page.send", "/free_gfit/" + freeGift.appId);
			}
		});
	},
	getData: function(cb) {
		var _param = {
			appid: freeGift.appId
		};
		var _cb = function(re) {
			if (re.ecode == 0) {
				cb && cb(re);
				try {
					if (re.freegifts) {
						parent.C.canvas.dialogCallback({
							call: "gift",
							giftNum: re.freegifts.length
						});
					}
				} catch (e) {}
			} else {
				if (re.msg) {
					freeGift.dialog.show(re.msg);
				} else {
					freeGift.dialog.show("系统繁忙，请稍后再试");
				}
			}
		};
		freeGift.dao.getData({
			key: "receiveInfo",
			data: _param,
			cb: _cb
		});
	},
	onFriendListReady: function() {
		this._friendListReady = true;
		this._checkCanRender();
	},
	_receiveGift: function(receiveId, type, cb) {
		var _param = {
			appid: freeGift.appId,
			action: type,
			index_id: receiveId
		};
		var _cb = function(re) {
			if (re.ecode == 0) {
				try {
					parent.C.canvas.dialogCallback(re.change);
				} catch (e) {}
			} else {
				var errMsg = re.msg || "系统繁忙，请稍后再试"
				if (parent.C && parent.C.canvas.errMsgMap && parent.C.canvas.errMsgMap[re.ecode]) {
					errMsg = parent.C.canvas.errMsgMap[re.ecode];
				}
				freeGift.dialog.show(errMsg);
			}
			cb && cb(re);
		};
		freeGift.dao.getData({
			key: "receiveGift",
			data: _param,
			cb: _cb
		});
	},
	_receiveGiftComplete: function(receiveId, _giftId, msg) {
		var _gift = freeGift.gifts[receiveId];
		freeGift.dialog.showReward(msg, _gift);
		var _itemElem = $e(this._receiveGiftListElem).find("li[rid=" + _giftId + "]").elements[0];
		_itemElem.removeAttribute("rid");
		QZFL.css.addClassName(_itemElem, "e_hide");
		var _giftCount = $e(this._receiveGiftListElem).find("li[rid]").elements;
		// start
		$('menuCtrol').getElementsByTagName("a")[1].innerHTML = "收到礼物(" + _giftCount.length + ")";
		// end
		if (!_giftCount || _giftCount.length == 0) {
			this._needUpdate = true;
			this._hasReceive = true;
			this.update();
		}
		try {
			parent.C.canvas.dialogCallback({
				call: "gift",
				giftNum: _giftCount.length
			});
		} catch (e) {}
	}
};
var _initFn = function() {
	window._timePoints[2] = new Date();
	QZFL.config.FSHelperPage = "/qzone/v5/toolpages/fp_utf8.html";
	var _menuCtrolElem = $("menuCtrol");
	V.event.bindCommonEvent(_menuCtrolElem, "click", {
		showPage: function() {
			var _page = this.getAttribute("rel");
			freeGift.toPage(_page);
		}
	});
	freeGift.init();
	V.module.reporter.init({
		domain: freeGift.config.reportDomain,
		speedConfig: freeGift.config.speedReport,
		delay: 1000
	});
	V.module.reporter.report("/free_gift/" + freeGift.appId);
	// start
	document.getElementsByClassName("pop_close")[0].setAttribute("onclick", "if(parent.C.canvas.mokaHaveReceived){parent.H.user.load();}parent.C.canvas.closeDialog();return false;");
	// end
};
if (QZFL.userAgent.ie && QZFL.userAgent.ie < 8) {
	(function() {
		try {
			document.documentElement.doScroll("left");
		} catch (e) {
			setTimeout(arguments.callee, 1);
			return;
		}
		_initFn();
	})();
} else {
	QZFL.event.onDomReady(_initFn);
}