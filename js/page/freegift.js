H.share = {
	var freeGiftConfig = [{"asset_id": "29376","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_1_v_1.png","id": 1,"msg": "卡片修罗刀X1已赠送，请在“卡箱”查看","name": "卡片修罗刀","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29377","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_2_v_1.png","id": 2,"msg": "卡片赤龙守护矛X1已赠送，请在“卡箱”查看","name": "卡片赤龙守护矛","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29378","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_3_v_1.png","id": 3,"msg": "卡片乾坤扇x1已放入“卡箱”","name": "卡片乾坤扇","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29379","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_4_v_1.png","id": 4,"msg": "卡片金雕射日弓X1已赠送，请在“卡箱”查看","name": "卡片金雕射日弓","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29380","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_5_v_1.png","id": 5,"msg": "卡片逸龙剑X1已赠送，请在“卡箱”查看","name": "卡片逸龙剑","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29381","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_6_v_1.png","id": 6,"msg": "卡片雌雄双刃剑X1已赠送，请在“卡箱”查看","name": "卡片雌雄双刃剑","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29382","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_7_v_1.png","id": 7,"msg": "已为您增加10点经验","name": "10点魔卡经验","rewards_name": "点经验","show": 1,"type": "经验"}, {"asset_id": "29383","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_8_v_1.png","id": 8,"msg": "已为您增加20个魔法金币","name": "20魔法金币 ","rewards_name": "点经验","show": 1,"type": "金币"}, {"asset_id": "29964","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_9_v_1.png","id": 9,"msg": "卡片圣诞节X1已赠送，请在“卡箱”查看","name": "卡片圣诞节","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29965","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_10_v_1.png","id": 10,"msg": "卡片圣诞果X1已赠送，请在“卡箱”查看","name": "卡片圣诞果","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29966","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_11_v_1.png","id": 11,"msg": "卡片圣诞烛光X1已赠送，请在“卡箱”查看","name": "卡片圣诞烛光","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29967","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_12_v_1.png","id": 12,"msg": "卡片圣诞卡x1已放入“卡箱”","name": "卡片圣诞卡","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29968","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_13_v_1.png","id": 13,"msg": "卡片缤纷糖果x1已放入“卡箱”","name": "卡片缤纷糖果","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "29969","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_14_v_1.png","id": 14,"msg": "卡片金色铃铛x1已放入“卡箱”","name": "卡片金色铃铛","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "30312","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_15_v_1.png","id": 15,"msg": "卡片金条x1已放入“卡箱”","name": "卡片金条","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "30313","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_16_v_1.png","id": 16,"msg": "卡片金元宝x1已放入“卡箱”","name": "卡片金元宝","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "30314","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_17_v_1.png","id": 17,"msg": "卡片压岁钱x1已放入“卡箱”","name": "卡片压岁钱","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "30315","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_18_v_1.png","id": 18,"msg": "卡片彩灯x1已放入“卡箱”","name": "卡片彩灯","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "30316","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_19_v_1.png","id": 19,"msg": "卡片平安果x1已放入“卡箱”","name": "卡片平安果","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "30317","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_20_v_1.png","id": 20,"msg": "卡片红灯笼x1已放入“卡箱”","name": "卡片红灯笼","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31205","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_21_v_1.png","id": 21,"msg": "卡片天香百合X1已赠送，请在“卡箱”查看","name": "卡片天香百合","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31206","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_22_v_1.png","id": 22,"msg": "卡片丁香花X1已赠送，请在“卡箱”查看","name": "卡片丁香花","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31207","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_23_v_1.png","id": 23,"msg": "卡片文殊兰x1已放入“卡箱”","name": "卡片文殊兰","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31208","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_24_v_1.png","id": 24,"msg": "卡片康乃馨x1已放入“卡箱”","name": "卡片康乃馨","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31209","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_25_v_1.png","id": 25,"msg": "卡片马蹄莲x1已放入“卡箱”","name": "卡片马蹄莲","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31210","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_26_v_1.png","id": 26,"msg": "卡片艳蝶兰x1已放入“卡箱”","name": "卡片艳蝶兰","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31815","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_27_v_1.png","id": 27,"msg": "卡片卖柳条x1已放入“卡箱”","name": "卡片卖柳条","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31816","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_28_v_1.png","id": 28,"msg": "卡片饮菖蒲酒x1已放入“卡箱”","name": "卡片饮菖蒲酒","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31817","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_29_v_1.png","id": 29,"msg": "卡片走月亮x1已放入“卡箱”","name": "卡片走月亮","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31818","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_30_v_1.png","id": 30,"msg": "卡片荡秋千x1已放入“卡箱”","name": "卡片荡秋千","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31819","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_31_v_1.png","id": 31,"msg": "卡片放纸鸢x1已放入“卡箱”","name": "卡片放纸鸢","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "31820","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_32_v_1.png","id": 32,"msg": "卡片挂钟馗x1已放入“卡箱”","name": "卡片挂钟馗","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "34840","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_33_v_1.png","id": 33,"msg": "卡片深邃幽谧X1已赠送，请在“卡箱”查看","name": "卡片深邃幽谧","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "34841","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_34_v_1.png","id": 34,"msg": "卡片神秘悠远X1已赠送，请在“卡箱”查看","name": "卡片神秘悠远","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "34842","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_35_v_1.png","id": 35,"msg": "卡片异域风情X1已赠送，请在“卡箱”查看","name": "卡片异域风情","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "34843","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_36_v_1.png","id": 36,"msg": "卡片安宁祥和X1已赠送，请在“卡箱”查看","name": "卡片安宁祥和","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "34844","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_37_v_1.png","id": 37,"msg": "卡片典雅别致X1已赠送，请在“卡箱”查看","name": "卡片典雅别致","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "34845","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_38_v_1.png","id": 38,"msg": "纯净别致X1已赠送，请在“卡箱”查看","name": "卡片纯净别致","rewards_name": "点经验","show": 0,"type": "卡片"}, {"asset_id": "35686","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_39_v_5.png","id": 39,"msg": "卡片枇杷X1已赠送，请在“卡箱”查看","name": "卡片枇杷","rewards_name": "点经验","show": 1,"type": "卡片"}, {"asset_id": "35687","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_40_v_5.png","id": 40,"msg": "卡片绣花鞋X1已赠送，请在“卡箱”查看","name": "卡片绣花鞋","rewards_name": "点经验","show": 1,"type": "卡片"}, {"asset_id": "35688","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_41_v_5.png","id": 41,"msg": "卡片旗袍X1已赠送，请在“卡箱”查看","name": "卡片旗袍","rewards_name": "点经验","show": 1,"type": "卡片"}, {"asset_id": "35689","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_42_v_5.png","id": 42,"msg": "卡片荷包X1已赠送，请在“卡箱”查看","name": "卡片荷包","rewards_name": "点经验","show": 1,"type": "卡片"}, {"asset_id": "35690","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_43_v_5.png","id": 43,"msg": "卡片绣花扇X1已赠送，请在“卡箱”查看","name": "卡片绣花扇","rewards_name": "点经验","show": 1,"type": "卡片"}, {"asset_id": "35691","asset_url_freegift": "http://appimg.qq.com/freegift/365/freegift_44_v_5.png","id": 44,"msg": "卡片绣花手绢X1已赠送，请在“卡箱”查看","name": "卡片绣花手绢","rewards_name": "点经验","show": 1,"type": "卡片"}]

	_uin: 0, //我的uin
	_MyshareList: [], //撒礼列表
	init: function() {
		var dialog = jQuery("#share");
		if (dialog.children().length == 0) {
			dialog = jQuery('<div id="share"></div>');
			var html = '';
			html += '<div class="popup_module1 popup_share" id="DIV_MAIN" style="width:500px;">';
			html += '    <div class="title">';
			html += '        <h2>好友分享</h2>';
			html += '    </div>';
			html += '    <div class="mdl_c_c">';
			html += '        <div class="content_text">';
			html += '            <p class="popup_share_tips">小提示：这里将记录近期的20条分享</p>';
			html += '            <div class="popup_share_list">';
			html += '                <ul class="list_module" id="UL_GIFT_LIST">';
			html += '                </ul>';
			html += '            </div>';
			html += '        </div>';
			html += '    </div>';
			html += '    <!--样式结构 开始-->';
			html += '    <div class="mdl_t_l"></div>';
			html += '    <div class="mdl_t_c"><span></span></div>';
			html += '    <div class="mdl_t_r"></div>';
			html += '    <div class="mdl_c_l"><span></span></div>';
			html += '    <div class="mdl_c_r"><span></span></div>';
			html += '    <div class="mdl_b_l"></div>';
			html += '    <div class="mdl_b_c"><span></span></div>';
			html += '    <div class="mdl_b_r"></div>';
			html += '    <!--样式结构 结束-->';
			html += '</div>';
			html += '<div class="popup_module1 card_vipexchange" id="DIV_ALERT" style="display:none;width:400px;">';
			html += '    <div class="title">';
			html += '        <h2>温馨提示</h2>';
			html += '    </div>';
			html += '    <!--mdl_c_c 开始-->';
			html += '    <div class="mdl_c_c">';
			html += '        <div class="content">';
			html += '        <center><h3><strong id="STRONG_INFO" style="font-size:14px;"></strong></h3></center>';
			html += '        <div class="btns">';
			html += '            <button class="bt2_tx4" type="button" onclick="CARD.closeDialog();">确定</button>';
			html += '        </div>';
			html += '        </div>';
			html += '    </div>';
			html += '    <!--mdl_c_c 结束-->';
			html += '    <button class="close" type="button" title="关闭" onclick="CARD.closeDialog();">关闭</button>';
			html += '    <!--样式结构 开始-->';
			html += '    <div class="mdl_t_l"></div>';
			html += '    <div class="mdl_t_c"><span></span></div>';
			html += '    <div class="mdl_t_r"></div>';
			html += '    <div class="mdl_c_l"><span></span></div>';
			html += '    <div class="mdl_c_r"><span></span></div>';
			html += '    <div class="mdl_b_l"></div>';
			html += '    <div class="mdl_b_c"><span></span></div>';
			html += '    <div class="mdl_b_r"></div>';
			html += '    <!--样式结构 结束-->';
			html += '</div>';
			dialog.html(html);
		}
		dialog.dialog({
			minWidth: 530,
			title: "好友分享",
			dialogClass: "dialogClass",
			position: "top"
		});
		H.share._uin = H.user.getUin(); //获取当前登录用户的UIN
		H.share._getMyGiftList(); //获取当前用户的20条分享
	},

	_getMyGiftList: function() {
		function fnSucc(oXML) {
			var oElem = oXML.xmlDom.getElementsByTagName("QQHOME")[0];
			var iCode = parseInt(oElem.getAttribute("code"));
			if (iCode != 0) {
				fnFail(iCode);
				return;
			}
			var oColList = oXML.xmlDom.getElementsByTagName("Node");
			for (var i = 0; i < oColList.length; ++i) {
				var friendUin = parseInt(oColList[i].getAttribute("frienduin"));
				var userName = unescape(CARD.getFlashObj().getNickAtUin(friendUin));
				if (userName == '') {
					userName = friendUin + ''; //如果读不到用户的昵称，则显示QQ号码
				}
				var friendName = userName.replace(/\r\n/g, '').replace(/\r/g, '').replace(/\n/g, '').escHtml();
				H.share._MyshareList[H.share._MyshareList.length] = [friendName, parseInt(oColList[i].getAttribute("type")), parseInt(oColList[i].getAttribute("record")), parseInt(oColList[i].getAttribute("money")), parseInt(oColList[i].getAttribute("gift")), friendUin, parseInt(oColList[i].getAttribute("timestamp")), parseInt(oColList[i].getAttribute("data"))];
			}
			H.share._displayGiftInfo(); //开始显示好友分享的弹出框
		}

		function fnFail(iCode) {
			if (iCode == -1001) {
				closeDialog();
				CARD.showLogin();
				return;
			} else {
				sContent = "目前查看奖励的人太多了，请稍后再来";
			}

			jQuery('#share #DIV_MAIN').hide();
			jQuery('#share #STRONG_INFO').html(sContent); /**escNone**/
			jQuery('#share #DIV_ALERT').show();
		}

		var url = 'http://card.show.qq.com/cgi-bin/card_user_share_info?uin=' + H.share._uin + "&type=0";
		var xml_sender = new CARD.XHR(url, fnSucc, null, fnFail);
		xml_sender.send();
	},

	//显示好友分享的弹出框
	_displayGiftInfo: function() {
		var str = [];
		for (var i = H.share._MyshareList.length - 1; i >= 0; --i) {
			var _theme;
			var _card;
			if (H.share._MyshareList[i][1] == 1) {
				_theme = CARD.data.mapTheme[H.share._MyshareList[i][2]];
				if (_theme == undefined) {
					continue;
				}
			} else if (H.share._MyshareList[i][1] == 2) {} else if (H.share._MyshareList[i][1] == 3) {
				_card = CARD.data.mapCard[H.share._MyshareList[i][7]];
				if (_card == undefined) {
					continue;
				}
			} else { //兼容性处理，对于没有定义的类型就不显示。
				continue;
			}
			str[str.length] = '<li><span class="popup_share_list_h">';
			if (H.share._MyshareList[i][1] == 1) {
				str[str.length] = H.ui.getThemeBigLogo(_theme[0]) + '</span>';
				//str[str.length] = '<img src="http://appimg2.qq.com/card/img/theme/' + _theme[0] + '_big_logo"  alt="' + _theme[1] + '"/></span>';
			} else if (H.share._MyshareList[i][1] == 3) {
				str[str.length] = H.ui.getCardMiniImg(_card[0]) + '</span>';
				//str[str.length] = '<img src="/card/img/card/' + _card[0] + '_56?ver=0" alt="' + _card[2] + '"></span>';
			} else {
				str[str.length] = '<img src="http://appimg2.qq.com/card/ac/img/levelup.jpg" alt="" /></span>';
			}
			str[str.length] = '<div class="popup_share_list_c"><div class="popup_share_list_c_align"><span class="popup_share_list_c_align_sp">';
			str[str.length] = '<strong>' + H.share._MyshareList[i][0] + '</strong>';
			if (H.share._MyshareList[i][1] == 1) {
				str[str.length] = '集成了' + _theme[2] + '星套卡' + _theme[1] + '！';
				str[str.length] = '<br/>魔法学院奖励TA和好友们 <em>金币' + H.share._MyshareList[i][3] + '</em></span></div></div>';
			} else if (H.share._MyshareList[i][1] == 3) {
				str[str.length] = '和你换了' + H.share._MyshareList[i][2] + '张卡!';
				str[str.length] = '<br/>魔法学院奖励你 <em>金币' + H.share._MyshareList[i][3] + '</em></span></div></div>';
			} else {
				str[str.length] = '在魔法世界中升级到了Lv' + H.share._MyshareList[i][2] + '！';
				str[str.length] = '<br/>魔法学院奖励TA和好友们 <em>金币' + H.share._MyshareList[i][3] + '</em></span></div></div>';
			}
			str[str.length] = '<div class="popup_share_list_s" id="DIV_STATE_' + i + '"><span class="popup_share_icon_g"></span>';
			if (H.share._MyshareList[i][4] == 1)
				str[str.length] = '<em>领取成功！</em>';
			else
				str[str.length] = '<button class="bt_tx4" type="button" onclick="javascript:H.share._getShareGift(' + i + ')">领取奖励</button>';
			str[str.length] = '</div><span class="listm_q"></span><span class="listm_p"></span><span class="listm_z"></span><span class="listm_m"></span></li>';
		}
		jQuery('#UL_GIFT_LIST').html(str.join('').escNone());
	},

	//点击领取奖励按钮
	_getShareGift: function(target) {
		function fnSucc(oXml) {
			var obj = oXml.xmlDom.getElementsByTagName("QQHOME")[0];
			var iCode = obj.getAttribute("code");
			if (iCode != 0) {
				fnError(iCode);
				return;
			}
			$('#DIV_STATE_' + target).html('<span class="popup_share_icon_g"></span><em>领取成功！</em>'); /**escNone**/
		}

		function fnError(iCode) {
			var sContent;
			if (iCode == -1001) {
				closeDialog();
				CARD.showLogin();
				return;
			} else if (iCode == -10001) {
				sContent = "待领取的分享不存在";
			} else if (iCode == -10002) {
				sContent = "待领取的分享已经领取";
			} else {
				sContent = "目前领取奖励的人太多了，请稍后再来";
			}
			jQuery('#share #DIV_MAIN').hide();
			jQuery('#share #STRONG_INFO').html(sContent); /**escNone**/
			jQuery('#share #DIV_ALERT').show();
		}
		var sUrl = 'http://card.show.qq.com/cgi-bin/card_user_share_get?uin=' + H.share._uin + '&frienduin=' + H.share._MyshareList[target][5] + '&timestamp=' + H.share._MyshareList[target][6];
		var xhr = new CARD.XHR(sUrl, fnSucc, null, fnError);
		xhr.send();
	}
};



    QSFL.sns.XHR = function(sUrl, fnSucc, fnFail, fnError, sMethod, isAsync) {
        function _hash(str) 
        {
            var hash = 5381;
            for (var i = 0, len = str.length; i < len; ++i) {
                hash += (hash << 5) + str.charCodeAt(i);
            }
            return hash & 0x7fffffff;
        }
        function getToken() 
        {
            return _hash(QSFL.cookie.get("skey"));
        }
        var _arrData = sUrl.split("?");
        var _win = typeof (QSFL) == "undefined" ? QSFL.sns.getApplicationWindow() : window;
        var _method = (!sMethod || sMethod.toUpperCase() != "GET") ? "POST" : (sMethod = "GET");
        var _data = _method == "POST" ? _arrData[1] || "" : "";
        this._oSender = _method == "POST" ? new _win.QSFL.xhr.XHR(_arrData[0] + "?g_tk=" + getToken(), null, _method, _data, isAsync) : new _win.QSFL.xhr.XHR(sUrl + (sUrl.indexOf("?") < 0 ? "?" : "&") + "g_tk=" + getToken(), null, _method, _data, isAsync);
        this._oSender.onSuccess = fnSucc;
        this._oSender.onError = fnError;
    };